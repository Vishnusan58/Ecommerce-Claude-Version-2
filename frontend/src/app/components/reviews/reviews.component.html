<div class="reviews-container">
  <!-- Add Review Form -->
  @if (isLoggedIn && canReview) {
    <mat-card class="review-form-card">
      <mat-card-header>
        <mat-card-title>Write a Review</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="reviewForm" (ngSubmit)="submitReview()">
          <div class="rating-selector">
            <label>Your Rating:</label>
            <div class="stars">
              @for (star of [1,2,3,4,5]; track star) {
                <mat-icon
                  (click)="setRating(star)"
                  (mouseenter)="hoverRating = star"
                  (mouseleave)="hoverRating = 0"
                  [class.filled]="star <= (hoverRating || selectedRating)">
                  {{ star <= (hoverRating || selectedRating) ? 'star' : 'star_border' }}
                </mat-icon>
              }
            </div>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Your Review</mat-label>
            <textarea matInput formControlName="comment" rows="4" placeholder="Share your experience with this product..."></textarea>
            <mat-error>Review must be at least 10 characters</mat-error>
          </mat-form-field>

          <button mat-raised-button color="primary" type="submit" [disabled]="isSubmitting">
            @if (isSubmitting) {
              <mat-spinner diameter="20"></mat-spinner>
            } @else {
              Submit Review
            }
          </button>
        </form>
      </mat-card-content>
    </mat-card>
  }

  @if (isLoggedIn && !canReview && reviews.length > 0) {
    <p class="review-notice">
      <mat-icon>info</mat-icon>
      You can only review products you have purchased.
    </p>
  }

  <!-- Reviews List -->
  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
    </div>
  }

  @if (!isLoading && reviews.length === 0) {
    <div class="empty-state-small">
      <mat-icon>rate_review</mat-icon>
      <p>No reviews yet. Be the first to review!</p>
    </div>
  }

  @if (!isLoading && reviews.length > 0) {
    <div class="reviews-list">
      @for (review of reviews; track review.id) {
        <mat-card class="review-card">
          <div class="review-header">
            <div class="reviewer-info">
              <div class="avatar">{{ review.userName.charAt(0).toUpperCase() }}</div>
              <div>
                <strong>{{ review.userName }}</strong>
                <span class="review-date">{{ review.createdAt | date:'mediumDate' }}</span>
              </div>
            </div>
            <div class="review-rating">
              @for (star of [1,2,3,4,5]; track star) {
                <mat-icon>{{ star <= review.rating ? 'star' : 'star_border' }}</mat-icon>
              }
            </div>
          </div>
          <p class="review-comment">{{ review.comment }}</p>
        </mat-card>
      }
    </div>

    <mat-paginator
      [length]="totalElements"
      [pageSize]="pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="[5, 10]"
      (page)="onPageChange($event)">
    </mat-paginator>
  }
</div>
